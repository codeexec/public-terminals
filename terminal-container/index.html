<!DOCTYPE html>
<html>
<head>
    <title>Terminal</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            background: #2d2d30;
            padding: 10px;
            border-bottom: 1px solid #3e3e42;
            font-size: 14px;
            flex-shrink: 0;
        }
        #terminal {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
</head>
<body>
    <div class="header">Terminal Session - Connected</div>
    <div id="terminal"></div>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            scrollback: 10000,
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4'
            }
        });

        // Load FitAddon for proper terminal sizing
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        const terminalContainer = document.getElementById('terminal');
        term.open(terminalContainer);

        // Fit terminal to container - use setTimeout to ensure container is rendered
        setTimeout(() => {
            fitAddon.fit();
        }, 0);

        // Refit on window resize and send new size to backend
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        // Send terminal size to backend when it changes
        term.onResize(({ rows, cols }) => {
            console.log(`Terminal resized to ${cols}x${rows}`);
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(['set_size', rows, cols]));
            }
        });

        // Use wss:// for HTTPS, ws:// for HTTP
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(wsProtocol + '//' + window.location.host + '/websocket');

        ws.onopen = function() {
            console.log('WebSocket connected');
            // Fit again after connection to ensure proper sizing
            setTimeout(() => fitAddon.fit(), 100);
        };

        ws.onmessage = function(event) {
            // Terminado sends messages as JSON arrays: ["stdout", "data"] or ["setup", {}]
            try {
                const msg = JSON.parse(event.data);
                if (msg[0] === 'stdout') {
                    term.write(msg[1]);
                } else if (msg[0] === 'setup') {
                    console.log('Terminal setup complete');
                    // Fit after setup to ensure backend is synchronized
                    fitAddon.fit();
                }
            } catch (e) {
                console.error('Failed to parse message:', e);
            }
        };

        term.onData(function(data) {
            ws.send(JSON.stringify(['stdin', data]));
        });

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    </script>
</body>
</html>
