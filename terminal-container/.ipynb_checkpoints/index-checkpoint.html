<!DOCTYPE html>
<html>
<head>
    <title>Terminal</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
        }
        #terminal {
            width: 100vw;
            height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }
        .header {
            background: #2d2d30;
            padding: 10px;
            border-bottom: 1px solid #3e3e42;
            font-size: 14px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
</head>
<body>
    <div class="header">Terminal Session - Connected</div>
    <div id="terminal"></div>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4'
            }
        });
        term.open(document.getElementById('terminal'));

        // Use wss:// for HTTPS, ws:// for HTTP
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(wsProtocol + '//' + window.location.host + '/websocket');

        ws.onopen = function() {
            console.log('WebSocket connected');
        };

        ws.onmessage = function(event) {
            // Terminado sends messages as JSON arrays: ["stdout", "data"] or ["setup", {}]
            try {
                const msg = JSON.parse(event.data);
                if (msg[0] === 'stdout') {
                    term.write(msg[1]);
                } else if (msg[0] === 'setup') {
                    console.log('Terminal setup complete');
                }
            } catch (e) {
                console.error('Failed to parse message:', e);
            }
        };

        term.onData(function(data) {
            ws.send(JSON.stringify(['stdin', data]));
        });

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    </script>
</body>
</html>
